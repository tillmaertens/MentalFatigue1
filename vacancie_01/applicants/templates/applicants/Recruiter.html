{% block title %}Recruiter{% endblock %}

{% block content %}

<style>
    body {
        background-color: #FFFFFF;
        font-family: Arial, Helvetica, sans-serif;
        padding: 20px;
        margin: 0;
    }

    .recruiter-container {
        display: flex;
        height: auto;
        gap: 20px;
    }

    /* Left side - Video meeting placeholder */
    .left-panel {
        flex: 0.4;
        background-color: #f0f0f0;
        border: 2px solid #ddd;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        color: #666;
    }

    /* Right side - Applicant information */
    .right-panel {
        flex: 0.6;
        padding: 20px;
        border: 2px solid #ddd;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
    }

    /* Applicant selection buttons */
    .applicant-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
    }

    .applicant-tab {
        background-color: lightblue;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    .applicant-tab:hover {
        background-color: #87CEEB;
    }

    .applicant-tab.active {
        background-color: #4682B4;
        color: white;
    }

    /* Pie Chart Section */
    .pie-chart-section {
        background-color: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .pie-chart-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
    }

    .pie-chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 200px;
        position: relative;
    }

    #pieChart {
        max-width: 250px;
        max-height: 250px;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
    }

    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }

    .no-data-message {
        color: #666;
        font-style: italic;
        padding: 40px;
    }

    /* Applicant content area */
    .applicant-content {
        display: none;
        flex: 1;
    }

    .applicant-content.active {
        display: block;
    }

    .description-placeholder {
        background-color: #f9f9f9;
        border: 2px dashed #ccc;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        border-radius: 5px;
        color: #666;
        font-style: italic;
    }

    /* Document buttons */
    .document-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    .doc-button {
        background-color: #28a745;
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    .doc-button:hover {
        background-color: #218838;
    }

    /* Real-time indicator */
    .update-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #28a745;
        display: none;
    }

    .update-indicator.updating {
        display: block;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .chart-stats {
        margin-top: 15px;
        padding: 10px;
        background-color: white;
        border-radius: 5px;
        border: 1px solid #e9ecef;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        text-align: center;
    }

    .stat-item {
        padding: 8px;
    }

    .stat-value {
        font-size: 16px;
        font-weight: bold;
        color: #333;
    }

    .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
</style>

<div class="recruiter-container">
    <!-- Left Panel - Video Meeting -->
    <div class="left-panel">
        <div>ðŸ“¹ Video Meeting Placeholder</div>
    </div>

    <!-- Right Panel - Applicant Information -->
    <div class="right-panel">
        <!-- Applicant Selection Tabs -->
        <div class="applicant-tabs">
            {% for applicant in applicants %}
                <button type="button" class="applicant-tab"
                        onclick="showApplicant(event, '{{ applicant.id }}')">{{ applicant.name }}</button>
            {% endfor %}
        </div>

        <!-- Pie Chart Section -->
        <div class="pie-chart-section">
            <div class="pie-chart-title">
                ðŸ“Š Nutzwertanalyse - Applicant Comparison
                <div class="update-indicator" id="updateIndicator"></div>
            </div>

            <div class="pie-chart-container">
                <canvas id="pieChart" width="250" height="250"></canvas>
                <div id="noDataMessage" class="no-data-message">
                    No evaluation data available yet.<br>
                    Waiting for HR Coordinator to add criteria and scores...
                </div>
            </div>

            <div class="chart-legend" id="chartLegend"></div>

            <div class="chart-stats" id="chartStats" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalCriteria">0</div>
                        <div class="stat-label">Criteria</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">Total Points</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="lastUpdate">Never</div>
                        <div class="stat-label">Last Update</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Applicant Content -->
        {% for applicant in applicants %}
        <div id="applicant-{{ applicant.id }}" class="applicant-content">
            <div class="description-placeholder">
                {{ applicant.description }}
            </div>
            <div class="document-buttons">
                <button type="button" class="doc-button" onclick="openPDF(event, '{{ applicant.documents.cv }}')">CV</button>
                <button type="button" class="doc-button" onclick="openPDF(event, '{{ applicant.documents.job_reference }}')">Job Reference</button>
                <button type="button" class="doc-button" onclick="openPDF(event, '{{ applicant.documents.cover_letter }}')">Cover Letter</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
    // Simple applicant data from backend
    const applicantsData = {{ applicants|safe }};

    let pieChart = null;
    let lastDataString = '';

    // Applicant colors for pie chart
    const applicantColors = {
        'a': '#FF6384',
        'b': '#36A2EB',
        'c': '#FFCE56'
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Recruiter page loaded - Simple Version');
        console.log('Applicants data:', applicantsData);

        // Set first applicant as active
        const firstTab = document.querySelector('.applicant-tab');
        const firstContent = document.querySelector('.applicant-content');

        if (firstTab && firstContent) {
            firstTab.classList.add('active');
            firstContent.classList.add('active');
        }

        // Initialize pie chart
        initializePieChart();

        // Check for existing data immediately
        fetchNutzwertUpdate();

        // Start real-time updates
        startRealTimeUpdates();

        console.log('Recruiter page initialization complete');
    });

    function showApplicant(event, applicantId) {
        event.preventDefault();

        const contents = document.querySelectorAll('.applicant-content');
        contents.forEach(content => {
            content.classList.remove('active');
        });

        const tabs = document.querySelectorAll('.applicant-tab');
        tabs.forEach(tab => {
            tab.classList.remove('active');
        });

        document.getElementById('applicant-' + applicantId).classList.add('active');
        event.target.classList.add('active');
    }

    function initializePieChart() {
        const canvas = document.getElementById('pieChart');
        const ctx = canvas.getContext('2d');

        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false // We'll create a custom legend
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const percentage = context.dataset.data.reduce((a, b) => a + b, 0) > 0
                                    ? ((value / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1)
                                    : 0;
                                return `${label}: ${value} points (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function updatePieChart(nutzwertResults) {
        const canvas = document.getElementById('pieChart');
        const noDataMessage = document.getElementById('noDataMessage');
        const chartLegend = document.getElementById('chartLegend');
        const chartStats = document.getElementById('chartStats');

        console.log('Updating pie chart with USER DATA:', nutzwertResults);

        if (!nutzwertResults || !nutzwertResults.applicant_totals) {
            // No data available
            canvas.style.display = 'none';
            noDataMessage.style.display = 'block';
            chartLegend.innerHTML = '';
            chartStats.style.display = 'none';
            console.log('No data available for pie chart');
            return;
        }

        const totals = nutzwertResults.applicant_totals;
        const percentages = nutzwertResults.applicant_percentages || {};

        console.log('Totals from USER input:', totals);
        console.log('Percentages:', percentages);

        // Check if we have any data
        const hasData = Object.values(totals).some(value => value > 0);

        if (!hasData) {
            canvas.style.display = 'none';
            noDataMessage.style.display = 'block';
            chartLegend.innerHTML = '';
            chartStats.style.display = 'none';
            console.log('All values are 0, showing no data message');
            return;
        }

        // Show chart and hide no-data message
        canvas.style.display = 'block';
        noDataMessage.style.display = 'none';
        chartStats.style.display = 'block';

        // Prepare data for chart
        const labels = [];
        const data = [];
        const colors = [];

        applicantsData.forEach(applicant => {
            const applicantId = applicant.id;
            const total = totals[applicantId] || 0;

            if (total >= 0) { // Include all values, even 0
                labels.push(applicant.name);
                data.push(total);
                colors.push(applicantColors[applicantId] || '#999');
            }
        });

        console.log('Chart data prepared:', { labels, data, colors });

        // Update chart
        pieChart.data.labels = labels;
        pieChart.data.datasets[0].data = data;
        pieChart.data.datasets[0].backgroundColor = colors;
        pieChart.update();

        // Update custom legend
        updateLegend(labels, colors, totals, percentages);

        // Update stats
        updateStats(nutzwertResults);

        // Update last update time
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

        console.log('Pie chart updated successfully with USER SCORES');
    }

    function updateLegend(labels, colors, totals, percentages) {
        const chartLegend = document.getElementById('chartLegend');
        chartLegend.innerHTML = '';

        labels.forEach((label, index) => {
            const applicantId = applicantsData.find(a => a.name === label)?.id;
            const total = totals[applicantId] || 0;
            const percentage = percentages[applicantId] || 0;

            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.innerHTML = `
                <div class="legend-color" style="background-color: ${colors[index]}"></div>
                <span><strong>${label}</strong>: ${total} pts (${percentage}%)</span>
            `;
            chartLegend.appendChild(legendItem);
        });
    }

    function updateStats(nutzwertResults) {
        const evaluationData = JSON.parse(localStorage.getItem('evaluationData') || '{}');
        const totalCriteria = Object.keys(evaluationData).length;
        const totalPoints = Object.values(nutzwertResults.applicant_totals || {}).reduce((sum, val) => sum + val, 0);

        document.getElementById('totalCriteria').textContent = totalCriteria;
        document.getElementById('totalPoints').textContent = totalPoints;
    }

    function startRealTimeUpdates() {
        // Check localStorage for updates every 2 seconds
        setInterval(function() {
            fetchNutzwertUpdate();
        }, 2000);
    }

    function fetchNutzwertUpdate() {
        const updateIndicator = document.getElementById('updateIndicator');
        updateIndicator.classList.add('updating');

        try {
            // Read from localStorage (set by HR Coordinator)
            const storedResults = localStorage.getItem('nutzwertResults');

            if (storedResults) {
                const nutzwertResults = JSON.parse(storedResults);
                console.log('Found USER DATA in localStorage:', nutzwertResults);

                // Check if data has changed
                const dataString = JSON.stringify(nutzwertResults);
                if (dataString !== lastDataString) {
                    console.log('USER DATA has changed, updating pie chart');
                    updatePieChart(nutzwertResults);
                    lastDataString = dataString;
                } else {
                    console.log('USER DATA unchanged, skipping update');
                }
            } else {
                console.log('No USER DATA found in localStorage yet');
            }
        } catch (error) {
            console.error('Error reading USER DATA from localStorage:', error);
        } finally {
            updateIndicator.classList.remove('updating');
        }
    }

    function openPDF(event, pdfPath) {
        event.preventDefault();
        event.stopPropagation();

        const fullPath = '/static/applicants/' + pdfPath;
        const newWindow = window.open(fullPath, '_blank', 'noopener,noreferrer');

        if (newWindow) {
            newWindow.focus();
        }

        return false;
    }
</script>

{% endblock %}