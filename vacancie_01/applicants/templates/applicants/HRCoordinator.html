{% block title %}HR Coordinator{% endblock %}

{% block content %}

    <style>
        body {
            background-color: #FFFFFF;
            font-family: Arial, Helvetica, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .hr-coordinator-container {
            display: flex;
            height: auto;
            gap: 20px;
        }

        /* Left side - Video meeting placeholder */
        .left-panel {
            flex: 1;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #666;
            min-height: 400px;
        }

        /* Right side - HR Coordinator Information */
        .right-panel {
            flex: 1;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        /* Job Description Button */
        .job-description-section {
            text-align: center;
            margin-bottom: 20px;
        }

        .job-description-button {
            background-color: #f5f5f5;
            color: #555;
            padding: 25px 40px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .job-description-button:hover {
            background-color: #e9e9e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }


        /* Evaluation Form Styles */
        .evaluation-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .evaluation-controls {
            display: flex;
            gap: 10px;
        }

        .add-criteria-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .add-criteria-btn:hover {
            background-color: #0056b3;
        }

        .table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 350px;
        }

        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        .evaluation-table th {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .evaluation-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
        }

        .criteria-header {
            min-width: 120px;
            background-color: #e9ecef !important;
        }

        .applicant-header {
            min-width: 80px;
        }

        .relevance-header {
            min-width: 90px;
            background-color: #fff3cd !important;
        }

        .actions-header {
            min-width: 80px;
        }

        .criteria-input {
            width: 100%;
            border: none;
            background: transparent;
            padding: 5px;
            font-size: 14px;
            text-align: center;
        }

        .criteria-input:focus {
            outline: 2px solid #007bff;
            background-color: #f8f9fa;
        }

        .score-input {
            width: 50px;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 5px;
            text-align: center;
            font-size: 14px;
        }

        .score-input:focus {
            outline: 2px solid #007bff;
            border-color: #007bff;
        }

        .relevance-select {
            width: 80px;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 5px;
            font-size: 12px;
            background-color: white;
        }

        .relevance-select:focus {
            outline: 2px solid #007bff;
            border-color: #007bff;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

    </style>

    <!-- Skip Button -->
    <div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
        <button onclick="skipSession()"
                style="background: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer;">
            Skip Session
        </button>
    </div>

    <script>
        function skipSession() {
            if (confirm('Skip this session?')) {
                // Submit the form immediately
                document.querySelector('form').submit();
            }
        }
    </script>

    <!-- Session Info Bar -->
    <div style="background: #e3f2fd; padding: 10px; text-align: center; margin-bottom: 20px; border-radius: 5px;">
        <strong>Session {{ session_number }} of 6</strong>

    </div>


    <div class="hr-coordinator-container">
        <!-- Left Panel - Video Meeting -->
        <div class="left-panel">
            <div> Video Meeting Placeholder</div>
        </div>

        <!-- Right Panel - HR Coordinator Information -->
        <div class="right-panel">

            <!-- Job Description Button -->
            <div class="job-description-section">
                <button type="button" class="job-description-button" onclick="openPDF(event, 'JobDescription.pdf')">
                    ðŸ“„ Job Description
                </button>
            </div>

            <!-- Evaluation Form -->
            <div class="evaluation-container">
                <div class="evaluation-header">
                    <div class="evaluation-controls">
                        <button type="button" class="add-criteria-btn" onclick="addCriteria()">+ Add Criteria</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="evaluationTable" class="evaluation-table">
                        <thead>
                        <tr>
                            <th class="criteria-header">Criteria</th>
                            {% for applicant in applicants %}
                                <th class="applicant-header">{{ applicant.name }}</th>
                            {% endfor %}
                            <th class="relevance-header">Relevance</th>
                            <th class="actions-header">Actions</th>
                        </tr>
                        </thead>
                        <tbody id="evaluationBody">
                        <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple backend data
        const applicantsData = {{ applicants|safe }};
        const minScore = 0;
        const maxScore = 8;

        let criteriaCount = 0;
        let saveTimeouts = {}; // Store timeouts for debouncing

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            console.log('HR Coordinator loaded - Simple Version');
            console.log('Applicants data:', applicantsData);

            // Clear any old data to start fresh
            localStorage.removeItem('nutzwertResults');
            localStorage.removeItem('evaluationData');
            console.log('Cleared localStorage for fresh start');

            // Add initial empty row
            addCriteria();
        });

        function addCriteria() {
            addCriteriaRow('', {}, 'normal');
        }

        function addCriteriaRow(criterionText = '', scores = {}, relevance = 'normal') {
            criteriaCount++;
            const tbody = document.getElementById('evaluationBody');
            const row = document.createElement('tr');
            row.id = `criteria-${criteriaCount}`;

            // Build relevance dropdown options
            let relevanceOptions = '';
            ['low', 'normal', 'high'].forEach(option => {
                const selected = option === relevance ? 'selected' : '';
                relevanceOptions += `<option value="${option}" ${selected}>${option}</option>`;
            });

            // Build the row HTML dynamically - with debounced saving
            let rowHTML = `
            <td>
                <input type="text" class="criteria-input" placeholder="Enter criteria..."
                       value="${criterionText}" id="criteria-name-${criteriaCount}"
                       oninput="debouncedSaveCriterion(${criteriaCount})"
                       onblur="saveCriterion(${criteriaCount})">
            </td>
        `;

            // Add score input for each applicant
            applicantsData.forEach(applicant => {
                const score = scores[applicant.id] || '';
                rowHTML += `
                <td>
                    <input type="number" class="score-input" min="${minScore}" max="${maxScore}"
                           placeholder="${minScore}-${maxScore}" value="${score}"
                           id="score-${applicant.id}-${criteriaCount}"
                           oninput="debouncedSaveScore('${applicant.id}', ${criteriaCount})"
                           onchange="saveScore('${applicant.id}', ${criteriaCount})">
                </td>
            `;
            });

            // Add relevance dropdown
            rowHTML += `
            <td>
                <select class="relevance-select" id="relevance-${criteriaCount}"
                        onchange="saveRelevance(${criteriaCount})">
                    ${relevanceOptions}
                </select>
            </td>
        `;

            // Add delete button
            rowHTML += `
            <td>
                <button type="button" class="delete-btn" onclick="deleteCriteria(${criteriaCount})">Ã—</button>
            </td>
        `;

            row.innerHTML = rowHTML;
            tbody.appendChild(row);

            // Focus on the new criteria input if it's empty
            if (!criterionText) {
                setTimeout(() => {
                    document.getElementById(`criteria-name-${criteriaCount}`).focus();
                }, 100);
            }
        }

        function deleteCriteria(id) {
            const row = document.getElementById(`criteria-${id}`);
            const criteriaInput = document.getElementById(`criteria-name-${id}`);

            if (row && criteriaInput) {
                const criterion = criteriaInput.value.trim();
                row.remove();

                // Remove from local storage
                const storedData = getLocalEvaluationData();
                if (storedData[criterion]) {
                    delete storedData[criterion];
                    saveLocalEvaluationData(storedData);
                    updatePieChartData(storedData);
                }

                // Clear any pending timeout for this criteria
                if (saveTimeouts[`criteria-${id}`]) {
                    clearTimeout(saveTimeouts[`criteria-${id}`]);
                    delete saveTimeouts[`criteria-${id}`];
                }
            }
        }

        // Debounced saving functions
        function debouncedSaveCriterion(id) {
            // Clear existing timeout
            if (saveTimeouts[`criteria-${id}`]) {
                clearTimeout(saveTimeouts[`criteria-${id}`]);
            }

            // Set new timeout - save after 1.5 seconds of no typing
            saveTimeouts[`criteria-${id}`] = setTimeout(() => {
                saveCriterion(id);
                delete saveTimeouts[`criteria-${id}`];
            }, 1500);
        }

        function debouncedSaveScore(applicantId, criteriaId) {
            const timeoutKey = `score-${applicantId}-${criteriaId}`;

            // Clear existing timeout
            if (saveTimeouts[timeoutKey]) {
                clearTimeout(saveTimeouts[timeoutKey]);
            }

            // Set new timeout - save after 1 second of no typing
            saveTimeouts[timeoutKey] = setTimeout(() => {
                saveScore(applicantId, criteriaId);
                delete saveTimeouts[timeoutKey];
            }, 1000);
        }

        function saveCriterion(id) {
            updateCriterionData(id);
        }

        function saveScore(applicantId, criteriaId) {
            updateCriterionData(criteriaId);
        }

        function saveRelevance(criteriaId) {
            updateCriterionData(criteriaId);
        }

        function updateCriterionData(criteriaId) {
            const criteriaInput = document.getElementById(`criteria-name-${criteriaId}`);
            const relevanceSelect = document.getElementById(`relevance-${criteriaId}`);

            const criterionName = criteriaInput.value.trim();
            const relevance = relevanceSelect.value;

            if (!criterionName) {
                return;
            }

            // Collect all user-entered scores for this criterion
            const applicantScores = {};
            applicantsData.forEach(applicant => {
                const scoreInput = document.getElementById(`score-${applicant.id}-${criteriaId}`);
                const score = scoreInput.value;
                if (score) {
                    applicantScores[applicant.id] = parseInt(score);
                }
            });

            console.log('Saving criterion:', {
                name: criterionName,
                scores: applicantScores,
                relevance: relevance
            });

            // Store in localStorage for pie chart
            const evaluationData = getLocalEvaluationData();
            evaluationData[criterionName] = {
                name: criterionName,
                scores: applicantScores,
                relevance: relevance
            };
            saveLocalEvaluationData(evaluationData);

            // Update pie chart immediately
            updatePieChartData(evaluationData);

        }

        function getLocalEvaluationData() {
            try {
                return JSON.parse(localStorage.getItem('evaluationData')) || {};
            } catch (e) {
                return {};
            }
        }

        function saveLocalEvaluationData(data) {
            localStorage.setItem('evaluationData', JSON.stringify(data));
        }

        function updatePieChartData(evaluationData) {
            const results = {
                applicant_totals: {a: 0, b: 0, c: 0},
                applicant_percentages: {a: 0, b: 0, c: 0}
            };

            // Relevance factors
            const relevanceFactors = {low: 1, normal: 2, high: 3};

            // Calculate using USER-ENTERED SCORES only
            Object.keys(evaluationData).forEach(criterionName => {
                const criterionData = evaluationData[criterionName];
                const relevanceFactor = relevanceFactors[criterionData.relevance] || 2;

                // Use USER-ENTERED scores (not metadata)
                ['a', 'b', 'c'].forEach(applicantId => {
                    const userScore = criterionData.scores[applicantId] || 0;
                    const nutzwert = userScore * relevanceFactor;
                    results.applicant_totals[applicantId] += nutzwert;
                });
            });

            // Calculate percentages
            const totalPoints = Object.values(results.applicant_totals).reduce((sum, val) => sum + val, 0);
            if (totalPoints > 0) {
                ['a', 'b', 'c'].forEach(applicantId => {
                    results.applicant_percentages[applicantId] =
                        Math.round((results.applicant_totals[applicantId] / totalPoints) * 100);
                });
            }

            console.log('Updated pie chart with USER SCORES:', results);
            localStorage.setItem('nutzwertResults', JSON.stringify(results));
        }

        function openPDF(event, pdfPath) {
            event.preventDefault();
            event.stopPropagation();
            const fullPath = '/static/applicants/' + pdfPath;
            window.open(fullPath, '_blank', 'noopener,noreferrer');
            return false;
        }
    </script>

{% endblock %}