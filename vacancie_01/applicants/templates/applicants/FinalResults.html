{% block title %}Final Results - Mental Fatigue Experiment{% endblock %}

{% block content %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.29.1/plotly.min.js"></script>

    <style>
        body {
            background-color: #FFFFFF;
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            color: #333;
        }

        .completion-header {
            background-color: #f8f9fa;
            padding: 40px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #007bff;
            display: block;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            font-weight: bold;
        }

        .charts-section {
            margin: 30px 0;
        }

        .chart-container {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .results-table {
            background-color: white;
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid #dee2e6;
            margin: 30px 0;
        }

        .table-header {
            background-color: #f8f9fa;
            padding: 20px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 1px solid #dee2e6;
        }

        .section-divider {
            background-color: #e9ecef;
            padding: 10px 20px;
            font-weight: bold;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
        }

        .session-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
        }

        .session-row:nth-child(even) {
            background-color: #f8f9fa;
        }

        .row-header {
            background-color: #e9ecef;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            background-color: #007bff;
            color: white;
        }

        .baseline-badge {
            background-color: #6c757d;
        }

        .trend-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .trend-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
        }

        .trend-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .trend-indicator {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            background-color: white;
            border: 1px solid #e9ecef;
        }

        .trend-positive {
            color: #28a745;
        }

        .trend-negative {
            color: #dc3545;
        }

        .trend-stable {
            color: #6c757d;
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .task-performance {
            margin: 30px 0;
        }

        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .debriefing {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 30px;
            margin: 30px 0;
        }

        .thank-you {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .experiment-info {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
    </style>

    <form method="post">

        {# Experiment completion header #}
        <div class="completion-header">
            <h1>Experiment Complete</h1>
            <div class="completion-badge">Mental Fatigue Study - All {{ total_task_sessions }} Work Sessions + Baseline
                Completed
            </div>
            <p>Thank you for your participation in this comprehensive study</p>
        </div>

        {# Task progression summary statistics #}
        <div class="section-title">Work Task Progression (Vacancy 1 → Vacancy 2 → Vacancy 3)</div>
        <div class="summary-stats">
            <div class="stat-card">
                <span class="stat-value">{{ total_task_sessions }}</span>
                <div class="stat-label">Work Sessions Completed</div>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="avgTaskFatigue">{{ average_task_fatigue }}</span>
                <div class="stat-label">Average Task Fatigue</div>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="taskFatigueChange">{{ task_fatigue_increase }}</span>
                <div class="stat-label">Fatigue Progression</div>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="taskCognitiveChange">{{ task_cognitive_decline }}</span>
                <div class="stat-label">Performance Change</div>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="avgTaskEffort">{{ average_task_effort }}</span>
                <div class="stat-label">Avg Mental Effort</div>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="avgTaskMotivation">{{ average_task_motivation }}</span>
                <div class="stat-label">Avg Motivation</div>
            </div>
        </div>

        {# Task performance analysis section#}
        <div class="task-performance">
            <div class="section-title">Task Performance Analysis</div>
            <div class="performance-stats">
                <div class="stat-card">
                    <span class="stat-value" id="totalCriteria">0</span>
                    <div class="stat-label">Total Criteria Evaluated</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="correctCriteria">0</span>
                    <div class="stat-label">Correctly Assessed</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="incorrectCriteria">0</span>
                    <div class="stat-label">Assessment Errors</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="accuracyRate">0%</span>
                    <div class="stat-label">Overall Accuracy</div>
                </div>
            </div>
        </div>

        {# Data visualization section for task progression trends #}
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-title">Task Progression Trends (Vacancy 1 → 2 → 3)</div>
                <div id="taskProgressionChart" style="width:100%;height:400px;"></div>
            </div>

            {# Fatigue-performance correlation analysis for HR Coordinator role #}
            <div class="chart-container">
                <div class="chart-title">Task Fatigue vs Performance Accuracy</div>
                <div id="correlationChart" style="width:100%;height:400px;"></div>
            </div>
        </div>

        {# Complete results table with baseline and task sessions #}
        <div class="results-table">
            <div class="table-header">
                Complete Session Results
            </div>

            <div class="session-row row-header">
                <div><strong>Session</strong></div>
                <div><strong>Role/Type</strong></div>
                <div><strong>Fatigue</strong></div>
                <div><strong>Mental Effort/Energy</strong></div>
                <div><strong>Concentration</strong></div>
                <div><strong>Motivation</strong></div>
                <div><strong>Effort Worth</strong></div>
                <div><strong>Test Score</strong></div>
                <div><strong>RT (ms)</strong></div>
            </div>

            {# Baseline row with new measurements #}
            <div class="section-divider">Baseline Measurement</div>
            <div class="session-row">
                <div><strong>Baseline</strong></div>
                <div><span class="role-badge baseline-badge">Pre-Task</span></div>
                <div title="KSS Alertness (0=alert, 100=sleepy)">
                    {% if baseline_data.kss_alertness %}{{ baseline_data.kss_alertness }}/100{% else %}-{% endif %}
                </div>
                <div title="Mental effort to concentrate">
                    {% if baseline_data.mfi_concentration %}{{ baseline_data.mfi_concentration }}/100{% else %}
                        -{% endif %}
                </div>
                <div title="Thoughts wander">
                    {% if baseline_data.mfi_wander %}{{ baseline_data.mfi_wander }}/100{% else %}-{% endif %}
                </div>
                <div title="Motivation for upcoming tasks">
                    {% if baseline_data.baseline_motivation %}{{ baseline_data.baseline_motivation }}/100{% else %}
                        -{% endif %}
                </div>
                <div title="Ability to follow through">
                    {% if baseline_data.afi_follow %}{{ baseline_data.afi_follow }}/100{% else %}-{% endif %}
                </div>
                <div>{% if baseline_data.cognitive_score %}{{ baseline_data.cognitive_score }}/20{% else %}
                    -{% endif %}</div>
                <div>{% if baseline_data.cognitive_reaction_time %}{{ baseline_data.cognitive_reaction_time }}{% else %}
                    -{% endif %}</div>
            </div>

            {# Task sessions rows with 0-100 scale #}
            <div class="section-divider">Work Task Sessions</div>
            {% for session in task_sessions %}
                <div class="session-row">
                    <div><strong>{{ session.session_name }}</strong></div>
                    <div><span class="role-badge">{{ session.role }}</span></div>
                    <div class="session-data" data-fatigue="{{ session.fatigue_level }}">
                        {{ session.fatigue_level }}/100
                    </div>
                    <div class="session-data" data-effort="{{ session.mental_effort }}">
                        {{ session.mental_effort }}/100
                    </div>
                    <div class="session-data" data-concentration="{{ session.concentration_difficulty }}">
                        {{ session.concentration_difficulty }}/100
                    </div>
                    <div class="session-data" data-motivation="{{ session.motivation_level }}">
                        {{ session.motivation_level }}/100
                    </div>
                    <div class="session-data" data-effort-cost="{{ session.effort_cost_worth }}">
                        {% if session.effort_cost_worth %}{{ session.effort_cost_worth }}/100{% else %}-{% endif %}
                    </div>
                    <div class="session-data">
                        {% if session.cognitive_score %}{{ session.cognitive_score }}/20{% else %}-{% endif %}
                    </div>
                    <div class="session-data" data-reaction-time="{{ session.cognitive_reaction_time }}">
                        {% if session.cognitive_reaction_time %}{{ session.cognitive_reaction_time }}{% else %}
                            -{% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        {# Task progression trend analysis #}
        <div class="trend-analysis">
            <div class="trend-card">
                <div class="trend-title">Fatigue Progression</div>
                {% if task_fatigue_increase > 10 %}
                    <div class="trend-indicator trend-negative">
                        Significant Increase<br>
                        <small id="taskFatigueIncrease1">+{{ task_fatigue_increase }} points</small>
                    </div>
                    <p>Your fatigue levels increased substantially across the work sessions.</p>
                {% elif task_fatigue_increase > -10 %}
                    <div class="trend-indicator trend-stable">
                        Stable<br>
                        <small id="taskFatigueIncrease2">{{ task_fatigue_increase }} points</small>
                    </div>
                    <p>Your fatigue levels remained relatively stable during work tasks.</p>
                {% else %}
                    <div class="trend-indicator trend-positive">
                        Decreased<br>
                        <small id="taskFatigueIncrease3">{{ task_fatigue_increase }} points</small>
                    </div>
                    <p>Your fatigue levels decreased during work sessions.</p>
                {% endif %}
            </div>

            <div class="trend-card">
                <div class="trend-title">Cognitive Performance</div>
                {% if task_cognitive_decline > 2 %}
                    <div class="trend-indicator trend-negative">
                        Performance Decline<br>
                        <small id="taskCognitiveDecline1">-{{ task_cognitive_decline }} points</small>
                    </div>
                    <p>Your cognitive performance declined across work sessions.</p>
                {% elif task_cognitive_decline > -2 %}
                    <div class="trend-indicator trend-stable">
                        Stable Performance<br>
                        <small id="taskCognitiveDecline2">{{ task_cognitive_decline }} points</small>
                    </div>
                    <p>Your cognitive performance remained consistent during work tasks.</p>
                {% else %}
                    <div class="trend-indicator trend-positive">
                        Performance Improved<br>
                        <small id="taskCognitiveDecline3">+<span
                                id="cognitiveDeclineAbs">{{ task_cognitive_decline }}</span> points</small>
                    </div>
                    <p>Your cognitive performance improved across work sessions.</p>
                {% endif %}
            </div>

            <div class="trend-card">
                <div class="trend-title">Mental Effort</div>
                <div class="trend-indicator">
                    <span id="effortTrend">{{ task_effort_increase }} points</span>
                </div>
                <p id="effortDescription">Average effort required across tasks.</p>
            </div>

            <div class="trend-card">
                <div class="trend-title">Motivation Level</div>
                <div class="trend-indicator">
                    <span id="motivationTrend">{{ task_motivation_change }} points</span>
                </div>
                <p id="motivationDescription">Motivation change during work sessions.</p>
            </div>
        </div>

        {# Research context and findings summary #}
        <div class="debriefing">
            <h3>About This Research</h3>
            <p><strong>Purpose:</strong> This study investigated how mental fatigue develops during extended
                collaborative work sessions and how it affects cognitive performance.</p>

            <p><strong>Your Contribution:</strong> Your data will help researchers understand:</p>
            <ul>
                <li>How fatigue accumulates during digital collaboration across multiple work sessions</li>
                <li>The relationship between subjective fatigue and objective cognitive performance</li>
                <li>Individual differences in fatigue susceptibility and recovery</li>
                <li>The impact of effort-cost perception on task performance</li>
            </ul>

            <p><strong>Key Findings from Your Sessions:</strong></p>
            <ul>
                <li>You completed {{ total_task_sessions }} full collaborative work sessions</li>
                <li>Your task fatigue levels {% if task_fatigue_increase > 10 %}increased
                    significantly{% elif task_fatigue_increase < -10 %}decreased{% else %}remained stable{% endif %}
                    across work sessions
                </li>
                <li>Your cognitive performance {% if task_cognitive_decline > 2 %}
                    declined{% elif task_cognitive_decline < -2 %}improved{% else %}remained stable{% endif %} during
                    the experiment
                </li>
            </ul>
        </div>

        {# Participant appreciation and research impact statement #}
        <div class="thank-you">
            <h2>Thank You</h2>
            <p><strong>Your participation is invaluable for advancing our understanding of mental fatigue in digital
                work environments.</strong></p>

            <p>The data you provided will contribute to:</p>
            <ul>
                <li>Designing better break schedules for knowledge workers</li>
                <li>Developing fatigue-aware collaboration tools</li>
                <li>Understanding optimal task rotation strategies</li>
                <li>Creating personalized workload management systems</li>
            </ul>

            <div class="experiment-info">
                <strong>Experiment ID:</strong> {{ player.participant.code }}<br>
                <strong>Completion Date:</strong> <span id="completionDate"></span>
            </div>
        </div>

    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Format summary statistics (now on 0-100 scale)
            const avgTaskFatigue = {{ average_task_fatigue }};
            const taskFatigueIncrease = {{ task_fatigue_increase }};
            const taskCognitiveDecline = {{ task_cognitive_decline }};
            const avgTaskEffort = {{ average_task_effort }};
            const avgTaskMotivation = {{ average_task_motivation }};

            // Update summary statistics
            document.getElementById('avgTaskFatigue').textContent = avgTaskFatigue.toFixed(0) + '/100';
            document.getElementById('taskFatigueChange').textContent =
                (taskFatigueIncrease > 0 ? '+' : '') + taskFatigueIncrease.toFixed(0);
            document.getElementById('taskCognitiveChange').textContent =
                (taskCognitiveDecline > 0 ? '-' : '+') + Math.abs(taskCognitiveDecline).toFixed(0);
            document.getElementById('avgTaskEffort').textContent = avgTaskEffort.toFixed(0) + '/100';

            if (document.getElementById('cognitiveDeclineAbs')) {
                const cognitiveDeclineAbs = Math.abs(taskCognitiveDecline);
                document.getElementById('cognitiveDeclineAbs').textContent = cognitiveDeclineAbs.toFixed(0);
            }

            // Display current completion timestamp
            const now = new Date();
            const dateString = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('completionDate').textContent = dateString;

            // Generate task session data for visualization
            const taskSessionData = [
                {% for session in task_sessions %}
                    {
                        session: {{ session.session }},
                        name: "{{ session.session_name }}",
                        fatigue: {% if session.fatigue_level %}{{ session.fatigue_level }}{% else %}null{% endif %},
                        effort: {% if session.mental_effort %}{{ session.mental_effort }}{% else %}null{% endif %},
                        concentration: {% if session.concentration_difficulty %}{{ session.concentration_difficulty }}{% else %}null{% endif %},
                        motivation: {% if session.motivation_level %}{{ session.motivation_level }}{% else %}null{% endif %},
                        effortCost: {% if session.effort_cost_worth %}{{ session.effort_cost_worth }}{% else %}null{% endif %},
                        score: {% if session.cognitive_score %}{{ session.cognitive_score }}{% else %}null{% endif %},
                        reactionTime: {% if session.cognitive_reaction_time %}{{ session.cognitive_reaction_time }}{% else %}null{% endif %},
                        criteriaCorrect: {% if session.criteria_correct %}{{ session.criteria_correct }}{% else %}0{% endif %},
                        criteriaIncorrect: {% if session.criteria_incorrect %}{{ session.criteria_incorrect }}{% else %}0{% endif %}
                    },
                {% endfor %}
            ];

            // Filter valid data points for reliable trend analysis
            const validTaskData = taskSessionData.filter(d =>
                d.fatigue !== null && d.effort !== null &&
                d.concentration !== null && d.motivation !== null
            );

            if (validTaskData.length > 1) {
                // Create task progression visualization using Plotly
                const traces = [
                    {
                        x: validTaskData.map(d => d.name),
                        y: validTaskData.map(d => d.fatigue),
                        mode: 'lines+markers',
                        name: 'Fatigue',
                        line: {color: '#dc3545', width: 3},
                        marker: {size: 8}
                    },
                    {
                        x: validTaskData.map(d => d.name),
                        y: validTaskData.map(d => d.effort),
                        mode: 'lines+markers',
                        name: 'Mental Effort',
                        line: {color: '#fd7e14', width: 3},
                        marker: {size: 8}
                    },
                    {
                        x: validTaskData.map(d => d.name),
                        y: validTaskData.map(d => d.concentration),
                        mode: 'lines+markers',
                        name: 'Concentration Difficulty',
                        line: {color: '#ffc107', width: 3},
                        marker: {size: 8}
                    },
                    {
                        x: validTaskData.map(d => d.name),
                        y: validTaskData.map(d => d.motivation),
                        mode: 'lines+markers',
                        name: 'Motivation',
                        line: {color: '#28a745', width: 3},
                        marker: {size: 8}
                    }
                ];

                // Add effort-cost
                if (validTaskData.some(d => d.effortCost !== null)) {
                    traces.push({
                        x: validTaskData.map(d => d.name),
                        y: validTaskData.map(d => d.effortCost),
                        mode: 'lines+markers',
                        name: 'Effort Worth It',
                        line: {color: '#17a2b8', width: 3, dash: 'dash'},
                        marker: {size: 8}
                    });
                }

                const layout = {
                    xaxis: {title: 'Work Session'},
                    yaxis: {title: 'Rating (0-100)', range: [0, 100]},
                    legend: {orientation: 'h', y: -0.2},
                    margin: {l: 60, r: 40, t: 40, b: 80}
                };

                Plotly.newPlot('taskProgressionChart', traces, layout, {responsive: true});
            }

            // Generate task performance analysis for HR Coordinator role
            const sessionsWithCriteria = taskSessionData.filter(d =>
                d.session && (d.criteriaCorrect > 0 || d.criteriaIncorrect > 0)
            );

            if (sessionsWithCriteria.length > 0) {
                // Calculate evaluation accuracy metrics
                const totalCorrect = sessionsWithCriteria.reduce((sum, d) => sum + (d.criteriaCorrect || 0), 0);
                const totalIncorrect = sessionsWithCriteria.reduce((sum, d) => sum + (d.criteriaIncorrect || 0), 0);
                const totalCriteria = totalCorrect + totalIncorrect;
                const accuracyRate = totalCriteria > 0 ? (totalCorrect / totalCriteria * 100) : 0;

                document.getElementById('totalCriteria').textContent = totalCriteria;
                document.getElementById('correctCriteria').textContent = totalCorrect;
                document.getElementById('incorrectCriteria').textContent = totalIncorrect;
                document.getElementById('accuracyRate').textContent = accuracyRate.toFixed(1) + '%';

                // Create fatigue-performance correlation for task sessions
                const correlationData = sessionsWithCriteria.map(d => {
                    const sessionTotal = (d.criteriaCorrect || 0) + (d.criteriaIncorrect || 0);
                    const sessionAccuracy = sessionTotal > 0 ? (d.criteriaCorrect || 0) / sessionTotal * 100 : 0;
                    return {
                        session: d.session,
                        fatigue: d.fatigue || 0,
                        accuracy: sessionAccuracy,
                        name: d.name
                    };
                }).filter(d => d.fatigue > 0);

                if (correlationData.length > 1) {
                    const correlationTrace = {
                        x: correlationData.map(d => d.fatigue),
                        y: correlationData.map(d => d.accuracy),
                        mode: 'markers+lines',
                        type: 'scatter',
                        name: 'Accuracy vs Fatigue',
                        text: correlationData.map(d => d.name),
                        marker: {
                            size: 12,
                            color: correlationData.map(d => d.session),
                            colorscale: 'Viridis',
                            showscale: true,
                            colorbar: {title: 'Session'}
                        },
                        line: {color: '#007bff', width: 2}
                    };

                    const correlationLayout = {
                        xaxis: {title: 'Fatigue Level (0-100)', range: [0, 100]},
                        yaxis: {title: 'Task Accuracy (%)', range: [0, 100]},
                        margin: {l: 60, r: 60, t: 40, b: 60}
                    };

                    Plotly.newPlot('correlationChart', [correlationTrace], correlationLayout, {responsive: true});
                }
            }
        });
    </script>

{% endblock %}