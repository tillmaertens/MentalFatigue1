{% block title %}Business Partner{% endblock %}

{% block content %}

    <style>
        body {
            background-color: #FFFFFF;
            font-family: Arial, Helvetica, sans-serif;
            padding: 20px;
            margin: 0;
        }

        .business-partner-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 860px;
            margin: 0 auto;
        }

        /* Left side - Video meeting placeholder */
        .left-panel {
            width: 400px;
            height: 600px;
            max-width: 400px;
            max-height: 600px;
            min-width: 400px;
            min-height: 600px;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #666;
            overflow: hidden;
            box-sizing: border-box;
        }

        #meet {
            width: 100%;
            height: 100%;
        }

        /* Right side - HR Coordinator Information */
        .right-panel {
            width: 670px;
            height: 600px;
            max-width: 670px;
            max-height: 600px;
            min-width: 670px;
            min-height: 600px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .preference-header {
            font-size: 30px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            padding: 10px;
        }


        .email-button {
            position: absolute;
            bottom: 25px;
            right: 150px;
            width: 110px;
            height: 90px;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        .email-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
        }

        .email-button::before {
            content: '‚úâ';
            font-size: 28px;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .email-button::after {
            content: 'E-Mail';
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-transform: uppercase;
        }

        .sticky-button {
            position: absolute;
            bottom: 25px;
            right: 30px;
            width: 90px;
            height: 90px;
            background: linear-gradient(45deg, #ffeb3b 0%, #ffc107 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            font-family: 'Courier New', monospace;
        }

        .sticky-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .sticky-button::before {
            content: 'üìù';
            font-size: 24px;
            margin-bottom: 2px;
        }

        .sticky-button::after {
            content: 'Notes';
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-transform: uppercase;
        }

        /* PDF Modal Styles */
        .pdf-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }

        .pdf-iframe {
            width: 90%;
            height: 90%;
            max-width: 1000px;
            max-height: 800px;
            border: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        /* Image Modal Styles */
        .image-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }

        .image-container {
            max-width: 30%;
            max-height: 30%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
        }

        /* Shared Modal Styles */
        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 10000;
            transition: background-color 0.3s;
        }

        .modal-close-btn:hover {
            background-color: #c82333;
        }

        .error-message {
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .skip {
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .skip-button {
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .session-info-bar {
            background: #e3f2fd;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        /* Requirements Catalog Styles */
        .requirements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .requirements-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .requirements-notebook {
            width: 350px;
            height: 450px;
            margin: 20px auto 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .requirements-notebook:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .requirements-notebook img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .close-catalog-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .close-catalog-btn:hover {
            background-color: #5a6268;
        }

        .category-selection {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .category-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .category-btn {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background-color: #dee2e6;
        }

        .category-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .criteria-selection {
            margin-bottom: 20px;
            display: none;
        }

        .criteria-selection.show {
            display: block;
        }

        .criteria-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .criteria-item {
            padding: 7px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .criteria-item:hover {
            background-color: #e9ecef;
        }

        .criteria-item:last-child {
            border-bottom: none;
        }

        .selected-criteria {
            font-size: 16px;
            font-weight: bold;
            color: black;
        }

        .points-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .points-table th {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        .points-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .points-table .expression-cell {
            text-align: left;
            max-width: 300px;
        }

        .points-table .points-cell {
            color: black;
            min-width: 60px;
        }
    </style>

    {# Debug skip button for development and testing #}
    <div class="skip">
        <button onclick="skipSession()" class="skip-button">
            Skip Session
        </button>
    </div>

    {# Session progress indicator showing current session within vacancy #}
    <div class="session-info-bar">
        <strong>Session {{ session_number }} of {{ total_sessions }}</strong>
    </div>

    {# Main layout: Two-panel design mimicking collaborative workspace #}
    <div class="business-partner-container">

        {# Left panel: Video meeting simulation placeholder #}
        <div class="left-panel">
            <div id="meet"></div>
        </div>

        {# Right panel: Contains requirements catalog and document access tools #}
        <div class="right-panel">

            {# Default view: Requirements catalog access and document buttons #}
            <div id="defaultView">
                <div class="preference-header">Requirements</div>

                {# Requirements catalog notebook: Main interaction element #}
                {# Clicking opens the interactive requirements browsing interface #}
                <div class="requirements-notebook" onclick="showRequirementsCatalog()">
                    <img src="{{ static_path }}notebook.png" alt="Job Requirement Catalog"/>
                </div>

                {# Email access button: Opens PDF containing relevant email #}
                <button type="button" class="email-button" onclick="openPDF(event, 'Emails.pdf')" title="Open Emails">
                </button>

                {# Sticky notes button: Opens image containing notes and reminders #}
                <button type="button" class="sticky-button" onclick="openImage(event, 'StickyNotes.jpg')"
                        title="Open Sticky Notes">
                </button>
            </div>

            {# Requirements catalog interface: Hidden by default, shown when notebook is clicked #}
            <div id="requirementsCatalog" style="display: none;">

                {# Catalog header with title and close functionality #}
                <div class="requirements-header">
                    <div class="requirements-title">Requirements Catalog</div>
                    <button type="button" class="close-catalog-btn" onclick="closeRequirementsCatalog()">
                        √ó Close
                    </button>
                </div>

                {# Two-level navigation: Category ‚Üí Criterion selection for requirements catalog #}
                <div class="category-selection">
                    <div class="category-title">Select Category:</div>
                    <div class="category-buttons" id="categoryButtons">
                    </div>
                </div>

                <div id="criteriaSelection" class="criteria-selection">
                    <div class="category-title">Select Criterion:</div>
                    <div class="criteria-list" id="criteriaList">
                    </div>
                </div>

                {# Points table: Shows detailed scoring information for selected criterion #}
                <div id="pointsTableContainer" style="display: none;">
                    <div id="selectedCriteriaTitle" class="selected-criteria"></div>
                    <table class="points-table">
                        <thead>
                        <tr>
                            <th>Expression</th>
                            <th>Points</th>
                        </tr>
                        </thead>
                        <tbody id="pointsTableBody">
                        {# Table rows populated dynamically with point expressions from metadata #}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script src="https://haps-meeting.k8s.iism.kit.edu/external_api.js"></script>
    <script>
        // Import evaluation criteria data from Django backend
        // Contains all requirements with scores, categories, and point expressions
        const criteriaData = {{ criteria_data|safe }};

        // List of all unique categories for navigation
        const categories = {{ categories|safe }};

        // Criteria organized by category for efficient filtering
        const criteriaByCategory = {{ criteria_by_category|safe }};

        // Removes formatting artifacts from backend data
        function cleanText(text) {
            if (!text || typeof text !== 'string') return text;

            let cleaned = text;

            if (cleaned.startsWith('[') && cleaned.endsWith(']')) {
                cleaned = cleaned.slice(1, -1);
            }

            if ((cleaned.startsWith("'") && cleaned.endsWith("'")) ||
                (cleaned.startsWith('"') && cleaned.endsWith('"'))) {
                cleaned = cleaned.slice(1, -1);
            }

            return cleaned;
        }


        function skipSession() {
            // Development function: Skip current session for testing
            if (confirm('Skip this session?')) {
                document.querySelector('form').submit();
            }
        }

        function showRequirementsCatalog() {
            // Transition from default view to requirements catalog interface
            // Hides main interface and shows interactive catalog
            document.getElementById('defaultView').style.display = 'none';
            document.getElementById('requirementsCatalog').style.display = 'block';

            // Initialize the category selection interface
            initializeCategoryButtons();
        }

        function closeRequirementsCatalog() {
            // Return to default view from requirements catalog
            document.getElementById('defaultView').style.display = 'block';
            document.getElementById('requirementsCatalog').style.display = 'none';

            // Clear all selections and reset interface state
            resetSelections();
        }

        function initializeCategoryButtons() {
            // Creates category selection buttons from backend data
            // Each category groups related evaluation criteria
            const categoryButtonsContainer = document.getElementById('categoryButtons');
            categoryButtonsContainer.innerHTML = '';

            categories.forEach(category => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'category-btn';
                button.textContent = category;
                button.onclick = () => selectCategory(category, button);

                categoryButtonsContainer.appendChild(button);
            });
        }

        function selectCategory(category, buttonElement) {
            // Switch to selected category and load its criteria
            document.getElementById('pointsTableContainer').style.display = 'none';

            // Update button visual states
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            buttonElement.classList.add('active');

            // Load and display criteria for selected category
            showCriteriaForCategory(category);
        }

        function showCriteriaForCategory(category) {
            // Populates criteria list based on selected category
            // Uses criteriaByCategory data structure for efficient filtering
            const criteriaListContainer = document.getElementById('criteriaList');
            const criteriaSelection = document.getElementById('criteriaSelection');

            criteriaListContainer.innerHTML = '';

            // Get criteria for this category from backend data structure
            const categoryRequirements = criteriaByCategory[category] || [];

            // Create clickable items for each criterion in the category
            categoryRequirements.forEach(requirement => {
                const criteriaItem = document.createElement('div');
                criteriaItem.className = 'criteria-item';
                criteriaItem.textContent = requirement.name;
                criteriaItem.onclick = () => selectCriterion(requirement);

                criteriaListContainer.appendChild(criteriaItem);
            });

            // Show the criteria selection interface
            criteriaSelection.classList.add('show');
        }

        function selectCriterion(requirement) {
            // Handles individual criterion selection and displays detailed information
            // Transitions from criteria list to detailed points table view

            // Hide previous points table if any
            document.getElementById('pointsTableContainer').style.display = 'none';

            // Hide criteria selection list
            document.getElementById('criteriaSelection').classList.remove('show');

            document.getElementById('selectedCriteriaTitle').textContent = requirement.name;

            // Generate and populate the detailed points table
            generatePointsTable(requirement);

            // Show the points table interface
            document.getElementById('pointsTableContainer').style.display = 'block';
        }

        function generatePointsTable(requirement) {
            // Creates detailed scoring table for selected criterion
            // Shows point values and corresponding performance expressions
            const tableBody = document.getElementById('pointsTableBody');
            tableBody.innerHTML = '';

            // Find complete criterion data from metadata
            // requirement parameter only contains basic info, need full data for point expressions
            let fullCriterion = null;
            for (let criterion of criteriaData) {
                if (criterion.name === requirement.name) {
                    fullCriterion = criterion;
                    break;
                }
            }

            if (!fullCriterion) {
                // Handle case where criterion data is not available
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="2" style="text-align: center; color: #666;">No data available for this criterion</td>';
                tableBody.appendChild(row);
                return;
            }

            // Generate table rows for points from the criterion object directly
            for (let points = {{ min_score }}; points <= {{ max_score }}; points++) {
                const pointField = `requirement_point_is_${points}`;

                // Skip if this point level has no defined expression
                if (!fullCriterion.hasOwnProperty(pointField)) continue;

                const expression = fullCriterion[pointField];

                // Skip empty or undefined expressions
                if (!expression || expression === 'None' || expression.trim() === '') continue;

                // Create table row with expression and corresponding point value
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="expression-cell">${cleanText(expression)}</td>
                    <td class="points-cell">${points}</td>
                `;
                tableBody.appendChild(row);
            }

            // Show message if no valid point expressions were found
            if (tableBody.children.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="2" style="text-align: center; color: #666;">No points expressions defined for this criterion</td>';
                tableBody.appendChild(row);
            }
        }

        function resetSelections() {
            // Clears all selection states and returns interface to initial state
            // Called when closing catalog or starting fresh navigation
            document.getElementById('criteriaSelection').classList.remove('show');
            document.getElementById('pointsTableContainer').style.display = 'none';

            // Remove active styling from all category buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function openPDF(event, pdfPath) {
            // Opens PDF documents in full-screen modal overlay
            // Prevents event bubbling to avoid triggering parent element clicks
            event.preventDefault();
            event.stopPropagation();

            const fullPath = '{{ static_path }}' + pdfPath;

            // Create modal overlay with iframe for PDF display
            const modal = document.createElement('div');
            modal.id = 'pdfModal';
            modal.className = 'pdf-modal-overlay';

            const iframe = document.createElement('iframe');
            iframe.src = fullPath;
            iframe.className = 'pdf-iframe';

            // Create close button with multiple close mechanisms
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó Close';
            closeBtn.className = 'modal-close-btn';

            const closeModal = () => {
                if (document.getElementById('pdfModal')) {
                    document.body.removeChild(modal);
                }
            };

            // Multiple ways to close modal: button click, background click, escape key
            closeBtn.onclick = closeModal;
            modal.onclick = (e) => e.target === modal && closeModal();

            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleKeyPress);
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            modal.appendChild(iframe);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);

            return false;
        }

        function openImage(event, imagePath) {
            // Opens image files in modal overlay with error handling
            event.preventDefault();
            event.stopPropagation();

            const fullPath = '{{ static_path }}' + imagePath;

            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal-overlay';

            const imageContainer = document.createElement('div');
            imageContainer.className = 'image-container';

            const img = document.createElement('img');
            img.src = fullPath;
            img.className = 'modal-image';

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó Close';
            closeBtn.className = 'modal-close-btn';

            const closeModal = () => {
                if (document.getElementById('imageModal')) {
                    document.body.removeChild(modal);
                }
            };

            closeBtn.onclick = closeModal;
            modal.onclick = (e) => e.target === modal && closeModal();

            const handleKeyPress = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.removeEventListener('keydown', handleKeyPress);
                }
            };
            document.addEventListener('keydown', handleKeyPress);

            // Handle image loading errors gracefully
            img.onerror = () => {
                img.style.display = 'none';
                const errorMsg = document.createElement('div');
                errorMsg.textContent = 'Image could not be loaded';
                errorMsg.className = 'error-message';
                imageContainer.appendChild(errorMsg);
            };

            imageContainer.appendChild(img);
            modal.appendChild(imageContainer);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);

            return false;
        }

        // Video Meeting Integration
        document.addEventListener('DOMContentLoaded', function () {
            initializeVideoMeeting();
        });

        function initializeVideoMeeting() {
            const domain = "haps-meeting.k8s.iism.kit.edu";
            const TN_name = "P" + {{ player.id_in_group }};
            const options = {
                roomName: "VideoMeeting" + {{ player.group.id_in_subsession }},
                parentNode: document.querySelector('#meet'),
                configOverwrite: {
                    prejoinConfig: {enabled: false},
                    disableSelfView: false,
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    filmstrip: {disableResizable: true},
                    participantsPane: {
                        hideModeratorSettingsTab: true,
                        hideMoreActionsButton: true,
                        hideMuteAllButton: true
                    },
                    resolution: 480,
                    disableAEC: false,
                    disableNS: false,
                    constraints: {
                        video: {
                            height: {
                                ideal: 480,
                                max: 480,
                                min: 240
                            }
                        }
                    },
                    disableSimulcast: false,
                    enableLayerSuspension: true
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: ['microphone', 'camera', 'fodeviceselection'],
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_MEETING_NAME: false,
                    SHOW_MEETING_TIMER: false,
                    TILE_VIEW_MAX_COLUMNS: 2,
                    TILE_VIEW_ENABLED: true,
                    PARTICIPANT_MENU_BUTTONS: []
                },
                userInfo: {
                    displayName: TN_name,
                }
            };

            const api = new JitsiMeetExternalAPI(domain, options);
        }

    </script>

{% endblock %}